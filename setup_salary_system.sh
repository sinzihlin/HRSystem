#!/bin/bash
# è–ªè³‡ç³»çµ±åˆå§‹åŒ–è…³æœ¬

set -e  # å‡ºéŒ¯æ™‚åœæ­¢åŸ·è¡Œ

echo "ğŸ¢ HR è–ªè³‡ç³»çµ±åˆå§‹åŒ–"
echo "================================"
echo ""

# æª¢æŸ¥æ˜¯å¦åœ¨æ­£ç¢ºçš„ç›®éŒ„
if [[ ! -f "manage.py" ]]; then
    echo "âŒ éŒ¯èª¤ï¼šè«‹åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸‹åŸ·è¡Œæ­¤è…³æœ¬"
    exit 1
fi

# æª¢æŸ¥è™›æ“¬ç’°å¢ƒ
if [[ -z "$VIRTUAL_ENV" ]] && [[ ! -d "venv" ]]; then
    echo "âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è™›æ“¬ç’°å¢ƒ"
    echo "è«‹å…ˆå‰µå»ºè™›æ“¬ç’°å¢ƒæˆ–å•Ÿç”¨ç¾æœ‰çš„è™›æ“¬ç’°å¢ƒ"
    exit 1
fi

# å•Ÿç”¨è™›æ“¬ç’°å¢ƒï¼ˆå¦‚æœé‚„æ²’å•Ÿç”¨ï¼‰
if [[ -z "$VIRTUAL_ENV" ]] && [[ -d "venv" ]]; then
    echo "ğŸ”„ å•Ÿç”¨è™›æ“¬ç’°å¢ƒ..."
    source venv/bin/activate
fi

echo "ç¬¬ä¸€éšæ®µï¼šè³‡æ–™åº«é·ç§»"
echo "================================"

# å»ºç«‹æ–°çš„é·ç§»æª”æ¡ˆ
echo "ğŸ”„ å»ºç«‹è³‡æ–™åº«é·ç§»æª”æ¡ˆ..."
python manage.py makemigrations

# å¥—ç”¨é·ç§»
echo "ğŸ”„ å¥—ç”¨è³‡æ–™åº«é·ç§»..."
python manage.py migrate

echo "âœ… è³‡æ–™åº«é·ç§»å®Œæˆ"
echo ""

echo "ç¬¬äºŒéšæ®µï¼šè–ªè³‡ç³»çµ±è¨­å®š"
echo "================================"

# åˆå§‹åŒ–è–ªè³‡ç³»çµ±
echo "ğŸ”„ åˆå§‹åŒ–è–ªè³‡ç³»çµ±åŸºæœ¬è¨­å®š..."
python manage.py setup_salary_system

echo "âœ… è–ªè³‡ç³»çµ±è¨­å®šå®Œæˆ"
echo ""

echo "ç¬¬ä¸‰éšæ®µï¼šå»ºç«‹æ¸¬è©¦è³‡æ–™"
echo "================================"

read -p "æ˜¯å¦è¦å»ºç«‹æ¸¬è©¦è³‡æ–™ï¼Ÿ(y/n): " create_test_data

if [[ $create_test_data == "y" || $create_test_data == "Y" ]]; then
    echo "ğŸ”„ å»ºç«‹åŸºæœ¬æ¸¬è©¦è³‡æ–™..."
    python scripts/create_simple_fake_data.py
    
    echo "ğŸ”„ å»ºç«‹æ‰“å¡è¨˜éŒ„..."
    python scripts/create_punch_records.py
    
    echo "âœ… æ¸¬è©¦è³‡æ–™å»ºç«‹å®Œæˆ"
else
    echo "â­ï¸  è·³éæ¸¬è©¦è³‡æ–™å»ºç«‹"
fi

echo ""
echo "ğŸ‰ è–ªè³‡ç³»çµ±åˆå§‹åŒ–å®Œæˆï¼"
echo ""
echo "æ¥ä¸‹ä¾†æ‚¨å¯ä»¥ï¼š"
echo "1. å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨ï¼špython manage.py runserver"
echo "2. è¨ªå•ç³»çµ±ï¼šhttp://127.0.0.1:8000"
echo "3. ç®¡ç†å¾Œå°ï¼šhttp://127.0.0.1:8000/admin"
echo "4. è–ªè³‡ç®¡ç†ï¼šhttp://127.0.0.1:8000/salary/"
echo ""
echo "é è¨­ç®¡ç†å“¡å¸³è™Ÿï¼š"
echo "  ç”¨æˆ¶åï¼šadmin"
echo "  å¯†ç¢¼ï¼šadmin"
echo ""
echo "å¦‚éœ€å»ºç«‹æ–°çš„ç®¡ç†å“¡å¸³è™Ÿï¼Œè«‹åŸ·è¡Œï¼š"
echo "  python manage.py createsuperuser"
