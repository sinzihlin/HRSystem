{% extends "employee/base.html" %}
{% load custom_filters %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>{{ employee.name }} 的打卡紀錄</h1>
        <div class="header-actions">
            <button id="addPunchRecordBtn" class="btn btn-primary">新增打卡紀錄</button>
            <a href="{% url 'salary_list' %}" class="btn btn-secondary">返回薪資列表</a>
        </div>
    </div>

    <div class="content-area">
        <h3>新增打卡紀錄</h3>
        <form id="addPunchRecordForm" class="form-inline">
            <input type="hidden" id="employeeId" value="{{ employee.id }}">
            <div class="form-group">
                <label for="punchTypeSelect">類型：</label>
                <select id="punchTypeSelect" name="punch_type" class="form-control" required>
                    <option value="">請選擇</option>
                    <option value="IN">上班打卡</option>
                    <option value="OUT">下班打卡</option>
                </select>
            </div>
            <div class="form-group">
                <label for="punchDate">日期：</label>
                <input type="date" id="punchDate" name="punch_date" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="punchTime">時間：</label>
                <input type="time" id="punchTime" name="punch_time" class="form-control" step="1" required>
            </div>
            <button type="submit" class="btn btn-success">新增</button>
        </form>

        <hr>

        <h3>歷史打卡紀錄</h3>
        {% if punches %}
            <table class="table">
                <thead>
                    <tr>
                        <th>打卡時間</th>
                        <th>類型</th>
                    </tr>
                </thead>
                <tbody>
                    {% for punch in punches %}
                    <tr>
                        <td>{{ punch.punch_time|date:"Y-m-d H:i:s" }}</td>
                        <td>{{ punch.get_punch_type_display }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>目前沒有打卡紀錄。</p>
        {% endif %}
    </div>
</div>

<style>
.form-inline {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: flex-end;
    margin-bottom: 20px;
    padding: 15px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background-color: #f9f9f9;
}

.form-inline .form-group {
    margin-bottom: 0;
}

.form-inline .form-control {
    width: auto;
    min-width: 150px;
}

.form-inline button.btn {
    margin-left: auto; /* 將按鈕推到最右邊 */
}

@media (max-width: 768px) {
    .form-inline {
        flex-direction: column;
        align-items: stretch;
    }
    .form-inline button.btn {
        margin-left: 0; 
        width: 100%;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 設定預設日期為今天
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('punchDate').value = today;
    // 設定預設時間為當前時間
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    document.getElementById('punchTime').value = `${hours}:${minutes}:${seconds}`;

    const addPunchRecordForm = document.getElementById('addPunchRecordForm');
    if (addPunchRecordForm) {
        addPunchRecordForm.onsubmit = handleAddPunchRecord;
    }
});

function handleAddPunchRecord(event) {
    event.preventDefault();

    const employeeId = document.getElementById('employeeId').value;
    const punchType = document.getElementById('punchTypeSelect').value;
    const punchDate = document.getElementById('punchDate').value;
    const punchTime = document.getElementById('punchTime').value;

    // 組合日期和時間
    const punchTimeStr = `${punchDate} ${punchTime}`;

    const data = {
        employee_id: employeeId,
        punch_type: punchType,
        punch_time: punchTimeStr
    };

    fetch('/api/punch/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('打卡紀錄新增成功！');
            location.reload(); // 重新載入頁面以顯示新的打卡紀錄
        } else {
            alert('新增失敗：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('新增時發生錯誤，請稍後再試');
    });
}

// 取得Cookie值（用於CSRF）
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
