<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å“¡å·¥åˆ—è¡¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        h1 {
            color: #333;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            color: #555;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .message-box {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: none;
        }
        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .punch-form-group, .leave-form-group {
            margin-bottom: 15px;
        }
        .punch-form-group label, .leave-form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .punch-form-group input[type="date"],
        .punch-form-group input[type="time"],
        .leave-form-group input[type="date"],
        .leave-form-group select,
        .leave-form-group textarea {
            width: calc(100% - 22px);
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .punch-form-group input[type="radio"] {
            margin-right: 5px;
        }
        .punch-form-group span {
            margin-right: 15px;
        }

        /* New Leave Approval Modal Styles */
        #leaveApprovalModal .modal-content {
            max-width: 800px; /* Make it wider */
            margin-top: 5%; /* Move it a bit higher */
        }
        .leave-approval-list {
            max-height: 400px; /* Scrollable area for leaves */
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 5px;
        }
        .leave-request-item {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .leave-request-item p {
            margin: 5px 0;
        }
        .leave-request-item button {
            padding: 8px 12px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .leave-request-item .approve-btn {
            background-color: #28a745;
            color: white;
        }
        .leave-request-item .approve-btn:hover {
            background-color: #218838;
        }
        .leave-request-item .reject-btn {
            background-color: #dc3545;
            color: white;
        }
        .leave-request-item .reject-btn:hover {
            background-color: #c82333;
        }

        /* Red dot for notification */
        .notification-dot {
            position: absolute;
            top: -5px;
            right: -5px;
            height: 12px;
            width: 12px;
            background-color: red;
            border-radius: 50%;
            display: none; /* Hidden by default */
        }
        #openLeaveApprovalModal {
            position: relative; /* For positioning the dot */
        }
    </style>
</head>
<body>
    <h1>å“¡å·¥åˆ—è¡¨</h1>
    <p>
        <button id="openImportModal">åŒ¯å…¥å“¡å·¥è³‡æ–™</button>
        <button id="openLeaveApprovalModal">å¯©æ ¸è«‹å‡ <span id="notificationDot" class="notification-dot"></span></button>
        <button id="testButton" style="background-color: #f0ad4e; color: white;">æ¸¬è©¦é€£æ¥</button>
    </p>

    <table>
        <thead>
            <tr>
                <th>å§“å</th>
                <th>é›»å­éƒµä»¶</th>
                <th>é›»è©±</th>
                <th>éƒ¨é–€</th>
                <th>åˆ°è·æ—¥æœŸ</th>
                <th>ç¸½è–ªè³‡ (æœ€è¿‘ä¸€ç­†)</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for employee in employees %}
            <tr>
                <td><a href="{% url 'employee_detail' employee.id %}">{{ employee.name }}</a></td>
                <td>{{ employee.email }}</td>
                <td>{{ employee.phone }}</td>
                <td>{{ employee.department.name }}</td>
                <td>{{ employee.hire_date }}</td>
                <td>
                    {% if employee.salary_set.last %}
                        {{ employee.salary_set.last.total_salary }}
                    {% else %}
                        ç„¡è–ªè³‡è³‡æ–™
                    {% endif %}
                </td>
                <td>
                    <button class="openPunchModal" data-employee-id="{{ employee.id }}" data-employee-name="{{ employee.name }}">æ‰“å¡</button>
                    <button class="openLeaveModal" data-employee-id="{{ employee.id }}" data-employee-name="{{ employee.name }}">è«‹å‡</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">
                    {% if database_error %}
                        <div style="color: #dc3545;">
                            <strong>âš ï¸ {{ error_message }}</strong>
                        </div>
                    {% elif has_employees == False %}
                        <div>
                            <h3 style="color: #6c757d; margin-bottom: 15px;">ğŸ“‹ é‚„æ²’æœ‰å“¡å·¥è³‡æ–™</h3>
                            <p style="margin-bottom: 20px;">{{ no_data_message|default:"ç³»çµ±ä¸­é‚„æ²’æœ‰å“¡å·¥è³‡æ–™ï¼Œæ‚¨å¯ä»¥é–‹å§‹æ–°å¢å“¡å·¥ã€‚" }}</p>
                            <button id="openImportModal" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                                ğŸ”„ åŒ¯å…¥å“¡å·¥è³‡æ–™
                            </button>
                        </div>
                    {% else %}
                        <div style="color: #dc3545;">
                            <strong>è¼‰å…¥å“¡å·¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚</strong>
                        </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>åŒ¯å…¥å“¡å·¥è³‡æ–™</h2>
            <div id="messageBox" class="message-box"></div>
            <form id="importForm" enctype="multipart/form-data">
                {% csrf_token %}
                <label for="csv_file">é¸æ“‡ CSV æª”æ¡ˆ:</label>
                <input type="file" name="csv_file" id="csv_file" accept=".csv" required>
                <button type="submit">ä¸Šå‚³ä¸¦åŒ¯å…¥</button>
            </form>
        </div>
    </div>

    <!-- Punch Modal -->
    <div id="punchModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closePunchModal">&times;</span>
            <h2 id="punchModalTitle">ç‚º [å“¡å·¥å§“å] æ‰“å¡</h2>
            <div id="punchMessageBox" class="message-box"></div>
            <form id="punchForm">
                {% csrf_token %}
                <input type="hidden" id="punchEmployeeId" name="employee_id">
                <div class="punch-form-group">
                    <label>æ‰“å¡é¡å‹:</label><br>
                    <span>
                        <input type="radio" id="punchTypeIn" name="punch_type" value="IN" checked>
                        <label for="punchTypeIn">ä¸Šç­æ‰“å¡</label>
                    </span>
                    <span>
                        <input type="radio" id="punchTypeOut" name="punch_type" value="OUT">
                        <label for="punchTypeOut">ä¸‹ç­æ‰“å¡</label>
                    </span>
                </div>
                <div class="punch-form-group">
                    <label for="punchDate">æ—¥æœŸ:</label>
                    <input type="date" id="punchDate" name="punch_date" required>
                </div>
                <div class="punch-form-group">
                    <label for="punchTime">æ™‚é–“:</label>
                    <input type="time" id="punchTime" name="punch_time" required>
                </div>
                <button type="submit">ç¢ºèªæ‰“å¡</button>
            </form>
        </div>
    </div>

    <!-- Leave Modal -->
    <div id="leaveModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeLeaveModal">&times;</span>
            <h2 id="leaveModalTitle">ç‚º [å“¡å·¥å§“å] æäº¤è«‹å‡ç”³è«‹</h2>
            <div id="leaveMessageBox" class="message-box"></div>
            <form id="leaveForm">
                {% csrf_token %}
                <input type="hidden" id="leaveEmployeeId" name="employee_id">
                <div class="leave-form-group">
                    <label for="leaveType">è«‹å‡é¡å‹:</label>
                    <select id="leaveType" name="leave_type" required>
                        <option value="ANNUAL">ç‰¹ä¼‘</option>
                        <option value="SICK">ç—…å‡</option>
                        <option value="PERSONAL">äº‹å‡</option>
                        <option value="MARRIAGE">å©šå‡</option>
                        <option value="FUNERAL">å–ªå‡</option>
                        <option value="MATERNITY">ç”¢å‡</option>
                        <option value="PATERNITY">é™ªç”¢å‡</option>
                        <option value="PUBLIC">å…¬å‡</option>
                        <option value="COMPENSATORY">è£œä¼‘</option>
                    </select>
                </div>
                <div class="leave-form-group">
                    <label for="leaveStartDate">é–‹å§‹æ—¥æœŸ:</label>
                    <input type="date" id="leaveStartDate" name="start_date" required>
                </div>
                <div class="leave-form-group">
                    <label for="leaveEndDate">çµæŸæ—¥æœŸ:</label>
                    <input type="date" id="leaveEndDate" name="end_date" required>
                </div>
                <div class="leave-form-group">
                    <label for="leaveReason">è«‹å‡åŸå›  (å¯é¸):</label>
                    <textarea id="leaveReason" name="reason" rows="3"></textarea>
                </div>
                <button type="submit">æäº¤è«‹å‡ç”³è«‹</button>
            </form>
        </div>
    </div>

    <!-- Leave Approval Modal -->
    <div id="leaveApprovalModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeLeaveApprovalModal">&times;</span>
            <h2>å¾…å¯©æ ¸è«‹å‡ç”³è«‹</h2>
            <div id="leaveApprovalMessageBox" class="message-box"></div>
            <div class="leave-approval-list" id="pendingLeavesList">
                <!-- Pending leave requests will be loaded here -->
                <p>è¼‰å…¥ä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        // é™¤éŒ¯åŠŸèƒ½
        const DEBUG = true;
        function logDebug(message, data) {
            if (DEBUG) {
                console.log(`[DEBUG] ${message}`, data || '');
            }
        }

        // CSRF Token Helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrfToken = getCookie('csrftoken');
        logDebug('CSRF Token:', csrfToken);

        // Import Modal Logic
        var importModal = document.getElementById("importModal");
        var openImportBtn = document.getElementById("openImportModal");
        var closeImportSpan = importModal.getElementsByClassName("close-button")[0];
        var importMessageBox = document.getElementById("messageBox");

        openImportBtn.onclick = function() {
            importModal.style.display = "block";
            importMessageBox.style.display = "none";
        }

        closeImportSpan.onclick = function() {
            importModal.style.display = "none";
        }

        // Punch Modal Logic
        var punchModal = document.getElementById("punchModal");
        var closePunchSpan = document.getElementById("closePunchModal");
        var punchMessageBox = document.getElementById("punchMessageBox");
        var punchEmployeeIdInput = document.getElementById("punchEmployeeId");
        var punchModalTitle = document.getElementById("punchModalTitle");
        var punchDateInput = document.getElementById("punchDate");
        var punchTimeInput = document.getElementById("punchTime");

        document.querySelectorAll('.openPunchModal').forEach(button => {
            button.onclick = function() {
                var employeeId = this.dataset.employeeId;
                var employeeName = this.dataset.employeeName;
                punchEmployeeIdInput.value = employeeId;
                punchModalTitle.innerText = `ç‚º ${employeeName} æ‰“å¡`;
                
                // Set current date and time as default
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');

                punchDateInput.value = `${year}-${month}-${day}`;
                punchTimeInput.value = `${hours}:${minutes}`;

                punchMessageBox.style.display = "none";
                punchModal.style.display = "block";
            };
        });

        closePunchSpan.onclick = function() {
            punchModal.style.display = "none";
        }

        // Leave Modal Logic
        var leaveModal = document.getElementById("leaveModal");
        var closeLeaveSpan = document.getElementById("closeLeaveModal");
        var leaveMessageBox = document.getElementById("leaveMessageBox");
        var leaveEmployeeIdInput = document.getElementById("leaveEmployeeId");
        var leaveModalTitle = document.getElementById("leaveModalTitle");
        var leaveStartDateInput = document.getElementById("leaveStartDate");
        var leaveEndDateInput = document.getElementById("leaveEndDate");

        document.querySelectorAll('.openLeaveModal').forEach(button => {
            button.onclick = function() {
                var employeeId = this.dataset.employeeId;
                var employeeName = this.dataset.employeeName;
                leaveEmployeeIdInput.value = employeeId;
                leaveModalTitle.innerText = `ç‚º ${employeeName} æäº¤è«‹å‡ç”³è«‹`;

                // Set current date as default
                const now = new Date();
                const year = now.getFullYear();
                const month = (now.getMonth() + 1).toString().padStart(2, '0');
                const day = now.getDate().toString().padStart(2, '0');
                const today = `${year}-${month}-${day}`;
                leaveStartDateInput.value = today;
                leaveEndDateInput.value = today;

                leaveMessageBox.style.display = "none";
                leaveModal.style.display = "block";
            };
        });

        closeLeaveSpan.onclick = function() {
            leaveModal.style.display = "none";
        }

        window.onclick = function(event) {
            if (event.target == importModal) {
                importModal.style.display = "none";
            } else if (event.target == punchModal) {
                punchModal.style.display = "none";
            } else if (event.target == leaveModal) {
                leaveModal.style.display = "none";
            } else if (event.target == leaveApprovalModal) { // Close approval modal if clicked outside
                leaveApprovalModal.style.display = "none";
            }
        }

        // Handle Import Form Submission via AJAX
        document.getElementById('importForm').addEventListener('submit', function(e) {
            e.preventDefault();
            logDebug('æäº¤åŒ¯å…¥è¡¨å–®');

            var formData = new FormData(this);

            fetch('{% url "import_employees_api" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin'
            })
            .then(response => {
                logDebug('åŒ¯å…¥å›æ‡‰ç‹€æ…‹:', response.status);
                return response.json();
            })
            .then(data => {
                logDebug('åŒ¯å…¥å›æ‡‰æ•¸æ“š:', data);
                importMessageBox.style.display = "block";
                if (data.status === 'success') {
                    importMessageBox.className = 'message-box success';
                    importMessageBox.innerHTML = data.message;
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    importMessageBox.className = 'message-box error';
                    importMessageBox.innerHTML = data.message + (data.errors ? '<br>' + data.errors.join('<br>') : '');
                }
            })
            .catch(error => {
                logDebug('åŒ¯å…¥éŒ¯èª¤:', error);
                importMessageBox.style.display = "block";
                importMessageBox.className = 'message-box error';
                importMessageBox.innerHTML = 'åŒ¯å…¥å¤±æ•—: ' + error;
            });
        });

        // Handle Punch Form Submission via AJAX
        document.getElementById('punchForm').addEventListener('submit', function(e) {
            e.preventDefault();

            var employeeId = document.getElementById('punchEmployeeId').value;
            var punchType = document.querySelector('input[name="punch_type"]:checked').value;
            var punchDate = document.getElementById('punchDate').value;
            var punchTime = document.getElementById('punchTime').value;
            var punchDateTime = `${punchDate} ${punchTime}:00`; // Add seconds for consistency

            fetch('{% url "punch_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    'employee_id': employeeId,
                    'punch_type': punchType,
                    'punch_time': punchDateTime
                })
            })
            .then(response => {
                logDebug('æ‰“å¡å›æ‡‰ç‹€æ…‹:', response.status);
                return response.json();
            })
            .then(data => {
                logDebug('æ‰“å¡å›æ‡‰æ•¸æ“š:', data);
                punchMessageBox.style.display = "block";
                if (data.status === 'success') {
                    punchMessageBox.className = 'message-box success';
                    punchMessageBox.innerHTML = data.message;
                    setTimeout(() => {
                        punchModal.style.display = "none";
                        // Optionally, reload the page or update a punch history section
                    }, 1500);
                } else {
                    punchMessageBox.className = 'message-box error';
                    punchMessageBox.innerHTML = data.message;
                }
            })
            .catch(error => {
                logDebug('æ‰“å¡éŒ¯èª¤:', error);
                punchMessageBox.style.display = "block";
                punchMessageBox.className = 'message-box error';
                punchMessageBox.innerHTML = 'æ‰“å¡å¤±æ•—: ' + error;
            });
        });

        // Handle Leave Form Submission via AJAX
        document.getElementById('leaveForm').addEventListener('submit', function(e) {
            e.preventDefault();
            logDebug('æäº¤è«‹å‡è¡¨å–®');

            var employeeId = document.getElementById('leaveEmployeeId').value;
            var leaveType = document.getElementById('leaveType').value;
            var startDate = document.getElementById('leaveStartDate').value;
            var endDate = document.getElementById('leaveEndDate').value;
            var reason = document.getElementById('leaveReason').value;
            
            const leaveData = {
                'employee_id': employeeId,
                'leave_type': leaveType,
                'start_date': startDate,
                'end_date': endDate,
                'reason': reason
            };
            logDebug('è«‹å‡æ•¸æ“š:', leaveData);

            fetch('{% url "leave_api" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                credentials: 'same-origin',
                body: JSON.stringify(leaveData)
            })
            .then(response => {
                logDebug('è«‹å‡å›æ‡‰ç‹€æ…‹:', response.status);
                return response.json();
            })
            .then(data => {
                logDebug('è«‹å‡å›æ‡‰æ•¸æ“š:', data);
                leaveMessageBox.style.display = "block";
                if (data.status === 'success') {
                    leaveMessageBox.className = 'message-box success';
                    leaveMessageBox.innerHTML = data.message;
                    setTimeout(() => {
                        leaveModal.style.display = "none";
                        // No need to fetchPendingLeaves here, as it's for the approval modal
                    }, 1500);
                } else {
                    leaveMessageBox.className = 'message-box error';
                    leaveMessageBox.innerHTML = data.message;
                }
            })
            .catch(error => {
                logDebug('è«‹å‡éŒ¯èª¤:', error);
                leaveMessageBox.style.display = "block";
                leaveMessageBox.className = 'message-box error';
                leaveMessageBox.innerHTML = 'æäº¤è«‹å‡å¤±æ•—: ' + error;
            });
        });

        // Leave Approval Modal Logic
        var leaveApprovalModal = document.getElementById("leaveApprovalModal");
        var openLeaveApprovalBtn = document.getElementById("openLeaveApprovalModal");
        var closeLeaveApprovalSpan = document.getElementById("closeLeaveApprovalModal");
        var leaveApprovalMessageBox = document.getElementById("leaveApprovalMessageBox");
        var pendingLeavesList = document.getElementById("pendingLeavesList");
        var notificationDot = document.getElementById("notificationDot");

        openLeaveApprovalBtn.onclick = function() {
            leaveApprovalModal.style.display = "block";
            leaveApprovalMessageBox.style.display = "none";
            fetchPendingLeaves();
        }

        closeLeaveApprovalSpan.onclick = function() {
            leaveApprovalModal.style.display = "none";
        }

        async function fetchPendingLeaves() {
            pendingLeavesList.innerHTML = '<p>è¼‰å…¥ä¸­...</p>';
            logDebug('ç²å–å¾…å¯©æ ¸è«‹å‡ç”³è«‹');
            try {
                const response = await fetch('{% url "get_pending_leaves_api" %}', {
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                logDebug('å¾…å¯©æ ¸è«‹å‡å›æ‡‰ç‹€æ…‹:', response.status);
                const data = await response.json();
                logDebug('å¾…å¯©æ ¸è«‹å‡å›æ‡‰æ•¸æ“š:', data);

                if (data.status === 'success') {
                    renderPendingLeaves(data.leaves);
                    // Update notification dot
                    if (data.leaves.length > 0) {
                        notificationDot.style.display = "block";
                    } else {
                        notificationDot.style.display = "none";
                    }
                } else {
                    pendingLeavesList.innerHTML = '<p class="error">è¼‰å…¥è«‹å‡ç”³è«‹å¤±æ•—: ' + data.message + '</p>';
                    notificationDot.style.display = "none";
                }
            } catch (error) {
                pendingLeavesList.innerHTML = '<p class="error">è¼‰å…¥è«‹å‡ç”³è«‹å¤±æ•—: ' + error + '</p>';
                notificationDot.style.display = "none";
            }
        }

        function renderPendingLeaves(leaves) {
            pendingLeavesList.innerHTML = '';
            if (leaves.length === 0) {
                pendingLeavesList.innerHTML = '<p>ç›®å‰æ²’æœ‰å¾…å¯©æ ¸çš„è«‹å‡ç”³è«‹ã€‚</p>';
                return;
            }

            leaves.forEach(leave => {
                const leaveItem = document.createElement('div');
                leaveItem.className = 'leave-request-item';
                leaveItem.innerHTML = `
                    <p><strong>å“¡å·¥:</strong> ${leave.employee_name}</p>
                    <p><strong>é¡å‹:</strong> ${leave.leave_type}</p>
                    <p><strong>æ—¥æœŸ:</strong> ${leave.start_date} è‡³ ${leave.end_date}</p>
                    <p><strong>åŸå› :</strong> ${leave.reason || 'ç„¡'}</p>
                    <p><strong>ç”³è«‹æ—¥æœŸ:</strong> ${leave.applied_date}</p>
                    <button class="approve-btn" data-leave-id="${leave.id}">æ‰¹å‡†</button>
                    <button class="reject-btn" data-leave-id="${leave.id}">æ‹’çµ•</button>
                `;
                pendingLeavesList.appendChild(leaveItem);
            });

            document.querySelectorAll('.approve-btn').forEach(button => {
                button.onclick = function() {
                    updateLeaveStatus(this.dataset.leaveId, 'APPROVED');
                };
            });

            document.querySelectorAll('.reject-btn').forEach(button => {
                button.onclick = function() {
                    updateLeaveStatus(this.dataset.leaveId, 'REJECTED');
                };
            });
        }

        async function updateLeaveStatus(leaveId, status) {
            logDebug('æ›´æ–°è«‹å‡ç‹€æ…‹:', { leaveId, status });
            try {
                const response = await fetch('{% url "update_leave_status_api" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        'leave_id': leaveId,
                        'status': status
                    })
                });
                logDebug('æ›´æ–°è«‹å‡ç‹€æ…‹å›æ‡‰ç‹€æ…‹:', response.status);
                const data = await response.json();
                logDebug('æ›´æ–°è«‹å‡ç‹€æ…‹å›æ‡‰æ•¸æ“š:', data);

                if (data.status === 'success') {
                    leaveApprovalMessageBox.className = 'message-box success';
                    leaveApprovalMessageBox.innerHTML = data.message;
                    leaveApprovalMessageBox.style.display = "block";
                    fetchPendingLeaves(); // Refresh the list and update dot
                } else {
                    leaveApprovalMessageBox.className = 'message-box error';
                    leaveApprovalMessageBox.innerHTML = 'æ“ä½œå¤±æ•—: ' + data.message;
                    leaveApprovalMessageBox.style.display = "block";
                }
            } catch (error) {
                logDebug('æ›´æ–°è«‹å‡ç‹€æ…‹éŒ¯èª¤:', error);
                leaveApprovalMessageBox.className = 'message-box error';
                leaveApprovalMessageBox.innerHTML = 'æ“ä½œå¤±æ•—: ' + error;
                leaveApprovalMessageBox.style.display = "block";
            }
        }

        // Initial fetch when page loads
        document.addEventListener('DOMContentLoaded', fetchPendingLeaves);
        
        // æ¸¬è©¦æŒ‰éˆ•è™•ç†
        document.getElementById('testButton').addEventListener('click', function() {
            logDebug('æ¸¬è©¦æŒ‰éˆ•è¢«é»æ“Š');
            const testMessageBox = document.createElement('div');
            testMessageBox.className = 'message-box success';
            testMessageBox.style.display = 'block';
            testMessageBox.style.position = 'fixed';
            testMessageBox.style.top = '10px';
            testMessageBox.style.right = '10px';
            testMessageBox.style.zIndex = '9999';
            testMessageBox.innerHTML = 'æ¸¬è©¦æŒ‰éˆ•é»æ“ŠæˆåŠŸï¼æ™‚é–“ï¼š' + new Date().toLocaleTimeString();
            document.body.appendChild(testMessageBox);
            
            // 5ç§’å¾Œè‡ªå‹•ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                document.body.removeChild(testMessageBox);
            }, 5000);
            
            // æ¸¬è©¦ç°¡å–®çš„ API è«‹æ±‚
            fetch('{% url "get_pending_leaves_api" %}', {
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                logDebug('æ¸¬è©¦ API å›æ‡‰ç‹€æ…‹:', response.status);
                return response.json();
            })
            .then(data => {
                logDebug('æ¸¬è©¦ API å›æ‡‰æ•¸æ“š:', data);
                alert('API æ¸¬è©¦æˆåŠŸï¼è«‹æª¢æŸ¥æ§åˆ¶å°ä»¥æŸ¥çœ‹è©³ç´°ä¿¡æ¯ã€‚');
            })
            .catch(error => {
                logDebug('æ¸¬è©¦ API éŒ¯èª¤:', error);
                alert('API æ¸¬è©¦å¤±æ•—ï¼š' + error);
            });
        });
    </script>
</body>
</html>
